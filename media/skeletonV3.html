<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT-like Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=SÃ¶hne:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @import url({{cssPath}});
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div id="user-input-container">
            <div id="user-input">
                <textarea id="user-message" placeholder="Send a message..." rows="1" autofocus></textarea>
                <button id="send-button" onclick="sendMessage()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
    <script>
        const vscode = acquireVsCodeApi();
        
        const chatMessages = document.getElementById('chat-messages');
        const userMessageInput = document.getElementById('user-message');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.querySelector('.typing-indicator');

        function addMessage(content, messageDiv, messageClass=null) {
            if(messageClass){
                messageDiv.className = `message ${messageClass}`;
            }
            messageDiv.innerHTML = marked.parse(content);
            // chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        let previousEvent;

        async function sendMessage() {
            const userMessage = userMessageInput.value.trim();
            if (userMessage) {
                sendButton.disabled = true;
                window.removeEventListener('message', previousEvent);

                let userMessageDiv = document.createElement('div');
                chatMessages.appendChild(userMessageDiv);
                addMessage(userMessage, userMessageDiv, 'user-message');
                userMessageInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
                adjustTextareaHeight();

                vscode.postMessage({ commands: 'chat', text: userMessage });
                
                let messageDiv = document.createElement('div');
                let thinkingDiv = document.createElement('div');
                let responseDiv = document.createElement('div');
                messageDiv.className = 'message model-message';
                thinkingDiv.className = 'model-thinking';
                responseDiv.className = 'model-response';
                chatMessages.appendChild(messageDiv);
                messageDiv.appendChild(thinkingDiv);
                messageDiv.appendChild(responseDiv);
                
                previousEvent = async event => {
                    const {commands, text} = event.data;

                    if (commands === 'res-from-deepseek-go') {
                        const thinkMatch = text.toString().match(/<think>([\s\S]*)/s) || null;
                        
                        if (thinkMatch) {
                            addMessage(thinkMatch[1].trim(), thinkingDiv); // Render thinking message
                        }
                        else {
                            addMessage(text, responseDiv); // Render actual response
                        }
                        // chatMessages.scrollTop = chatMessages.scrollHeight;
                        // await simulateTyping(text);
                    }   
                }

                window.addEventListener('message', previousEvent);
                sendButton.disabled = false;
                }
            }  
            

        function adjustTextareaHeight() {
            userMessageInput.style.height = 'auto';
            userMessageInput.style.height = Math.min(userMessageInput.scrollHeight, 200) + 'px';
        }

        userMessageInput.addEventListener('input', function() {
            adjustTextareaHeight();
            sendButton.disabled = this.value.trim() === '';
        });

        userMessageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'c') {
                vscode.postMessage({ commands: 'abort' });
            }
        });

    </script>
</body>
</html>