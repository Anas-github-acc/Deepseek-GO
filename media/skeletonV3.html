<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT-like Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=SÃ¶hne:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @import url({{cssPath}});
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div id="user-input-container">
            <div id="user-input">
                <textarea id="user-message" placeholder="Send a message..." rows="1"></textarea>
                <button id="send-button" onclick="sendMessage()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
    <script>
        const vscode = acquireVsCodeApi();
        
        const chatMessages = document.getElementById('chat-messages');
        const userMessageInput = document.getElementById('user-message');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.querySelector('.typing-indicator');

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'model-message'}`;
            messageDiv.innerHTML = isUser ? content : marked.parse(content);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function simulateTyping(message) {
            return new Promise((resolve) => {
                typingIndicator.style.display = 'block';
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    addMessage(message, false);
                    resolve();
                }, 1500 + Math.random() * 1500);
            });
        }

        async function sendMessage() {
            const userMessage = userMessageInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
                userMessageInput.value = '';
                adjustTextareaHeight();
                sendButton.disabled = true;

                vscode.postMessage({ commands: 'chat', userMessage });

                const Response = document.createElement('div');
                Response.className = 'bot-typing';
                chatMessages.appendChild(Response);

                window.addEventListener('message', async event => {
                    const {commands, text} = event.data;
                    
                    if (commands === 'res-from-deepseek-go') {
                        Response.innerHTML = text;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        // await simulateTyping(text);
                    }
                });

                sendButton.disabled = false;

                // Simulate model response (replace this with actual API call)
                // const modelResponses = [
                //     "Here's a markdown response:\n\n# Hello\n\nThis is a **bold** text and this is *italic*.\n\n- List item 1\n- List item 2\n\n```javascript\nconsole.log('Hello, world!');\n```",
                //     "Sure, I can help with that. Here's an example of how to use a for loop in JavaScript:\n\n```javascript\nfor (let i = 0; i < 5; i++) {\n    console.log(`Iteration ${i}`);\n}\n```\n\nThis loop will run 5 times, printing the iteration number each time.",
                //     "Here's a brief explanation of REST APIs:\n\n1. REST stands for Representational State Transfer\n2. It's an architectural style for designing networked applications\n3. RESTful APIs use HTTP requests to perform CRUD operations:\n   - CREATE: POST\n   - READ: GET\n   - UPDATE: PUT/PATCH\n   - DELETE: DELETE\n\nRESTful APIs are stateless, meaning each request contains all the information needed to complete it."
                // ];

                // const randomResponse = modelResponses[Math.floor(Math.random() * modelResponses.length)];
                // await simulateTyping(randomResponse);
                // sendButton.disabled = false;
            }
        }


        function adjustTextareaHeight() {
            userMessageInput.style.height = 'auto';
            userMessageInput.style.height = Math.min(userMessageInput.scrollHeight, 200) + 'px';
        }

        userMessageInput.addEventListener('input', function() {
            adjustTextareaHeight();
            sendButton.disabled = this.value.trim() === '';
        });

        userMessageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>
</body>
</html>